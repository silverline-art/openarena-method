# v1.2.0 Metric Calibration - Implementation Status

**Date**: 2025-11-21
**Version**: 1.2.0-alpha
**Status**: PRD Complete, Implementation Pending

---

## Executive Summary

The v1.2.0 Metric Calibration upgrade has been **fully specified** with:
- ✅ Complete PRD (13,000 words)
- ✅ Production-ready config file
- ✅ Expected improvements quantified
- ✅ Implementation roadmap defined
- ⏳ Code implementation pending

**Next Action**: Begin Phase 1 implementation (Core Fixes)

---

## Documentation Status

| Document | Status | Location |
|----------|--------|----------|
| PRD | ✅ Complete | METRIC_CALIBRATION_PRD.md |
| Config v1.2 | ✅ Complete | config_v1.2_calibrated.yaml |
| API Updates | ⏳ Pending | docs/API_REFERENCE.md |
| User Guide | ⏳ Pending | docs/V1.2_MIGRATION_GUIDE.md |

---

## Configuration Validation

### ✅ config_v1.2_calibrated.yaml Test Results

**Config Loading**: ✅ PASSED
```yaml
Body length: 10.0 cm (was 8.0)
Scaling method: full_body (new)
Position smoothing: 7 frames (was 11)
Velocity smoothing: 5 frames (new)
ROM smoothing: 3 frames (new)
Walking MAD threshold: 0.8 (was 1.2)
Min stride duration: 0.06 s (was 0.08)
Use 3D COM: True (new)
ROM triplet angles: True (new)
Allow micro-steps: True (new)
```

**Dry-Run Test**: ✅ PASSED
```bash
python batch_process.py --config config_v1.2_calibrated.yaml --sample control_5 --dry-run
# Result: Config loads successfully, sample detected
```

**All Parameters Validated**: ✅ PASSED

---

## Implementation Requirements

### Phase 1: Core Fixes (Week 1)

#### 1.1 Preprocessor Updates

**File**: `src/exmo_gait/core/preprocessor.py`

**Required Changes**:
```python
# NEW: Full-body scaling method
def compute_scaling_factor_v2(
    snout_trajectory, tailbase_trajectory,
    expected_body_length_cm=10.0  # Updated from 8.0
):
    # Use snout→tailbase instead of spine1-3
    # Apply likelihood filtering
    # Return scaling + diagnostics

# NEW: Adaptive smoothing
def smooth_trajectory_adaptive(
    trajectory, data_completeness,
    window_size_base=7  # Reduced from 11
):
    # Adjust window based on data quality
    # High quality: window-2
    # Low quality: window+2

# NEW: Velocity EMA smoothing
def compute_velocity_ema(
    positions, alpha=0.35, fps=120.0
):
    # Exponential Moving Average for velocity
    # Less dampening than Savitzky-Golay
```

**Estimated Effort**: 4-6 hours

#### 1.2 Phase Detector Updates

**File**: `src/exmo_gait/analysis/phase_detector.py`

**Required Changes**:
```python
# NEW: Hybrid threshold calculation
def compute_adaptive_threshold_v2(
    velocity,
    mad_multiplier=0.8,  # Reduced from 1.2
    percentile_value=55,  # Reduced from 75
    min_threshold_px_per_frame=1.0
):
    # Hybrid: MAD + percentile
    # Safety lower bound

# MODIFY: PhaseDetector.__init__
# Add: use_hybrid_threshold parameter
# Add: min_threshold_px_per_frame parameter
```

**Estimated Effort**: 3-4 hours

#### 1.3 Step Detector Updates

**File**: `src/exmo_gait/analysis/step_detector.py`

**Required Changes**:
```python
# MODIFY: detect_steps()
# Update: min_stride_duration to 0.06s
# Add: allow_micro_steps parameter
# Add: micro_step_threshold_cm parameter

# NEW: Micro-step flagging
stride_info = {
    'start_frame': ...,
    'end_frame': ...,
    'duration_sec': ...,
    'length_cm': ...,
    'is_micro_step': length < 1.0  # NEW FLAG
}
```

**Estimated Effort**: 2-3 hours

**Phase 1 Total**: ~10-13 hours

---

### Phase 2: Metrics & Aggregation (Week 2)

#### 2.1 Metrics Computer Updates

**File**: `src/exmo_gait/analysis/metrics_computer.py`

**Required Changes**:
```python
# NEW: 3D COM calculation
def compute_com_3d(
    top_keypoints, side_keypoints,
    weights=None
):
    # Weighted average XY from TOP
    # Extract Z from SIDE
    # Return (N, 3) array

# NEW: 3D velocity
def compute_velocity_3d(
    com_3d, fps=120.0, scaling_factor=1.0
):
    # sqrt(dx² + dy² + dz²)
    # Scale to cm/s

# NEW: Triplet angle calculation
def compute_joint_angle(
    proximal, joint, distal
):
    # 3-point angle from vectors
    # Return angles in degrees

# NEW: ROM v2
def compute_rom_v2(
    side_keypoints, smoothing_window=3
):
    # Angle-based ROM
    # Hip: spine3 → hip → knee
    # Elbow: shoulder → elbow → paw
    # Angular velocity from derivative
```

**Estimated Effort**: 6-8 hours

#### 2.2 Aggregator Updates

**File**: `src/exmo_gait/statistics/aggregator.py`

**Required Changes**:
```python
# MODIFY: aggregate_metrics()
# Add: confidence intervals (95%)
# Add: corrected_mean (5% trimmed)
# Add: ci_low, ci_high, ci_range

def aggregate_metrics_v2(metric_values):
    return {
        'median': ...,
        'mad': ...,
        'mean': ...,
        'std': ...,
        'corrected_mean': ...,  # NEW
        'ci_low': ...,          # NEW
        'ci_high': ...,         # NEW
        'ci_range': ...,        # NEW
        'n_samples': ...
    }
```

**Estimated Effort**: 3-4 hours

**Phase 2 Total**: ~10-12 hours

---

### Phase 3: Visualization & Config (Week 3)

#### 3.1 Visualizer Updates

**File**: `src/exmo_gait/export/visualizer_enhanced.py`

**Required Changes**:
```python
# MODIFY: Y-axis margins
self.style.format_axis_range(ax, data, margin=0.20)  # Was 0.10

# NEW: Micro-step visualization
if config.get('plot_show_micro_steps'):
    micro_steps = [s for s in strides if s['is_micro_step']]
    ax.scatter(..., label='Micro-strides', marker='o', s=30)

# NEW: Threshold line overlays
if config.get('plot_show_threshold_lines'):
    ax.axhline(walking_threshold, linestyle='--',
               label=f'Walking threshold')

# NEW: 3D COM trajectory plot
def plot_com_3d_trajectory(self, com_3d):
    # XY projection + Z height
```

**Estimated Effort**: 4-5 hours

#### 3.2 CLI Integration

**File**: `src/exmo_gait/cli.py`

**Required Changes**:
```python
# MODIFY: run_pipeline()
# Pass new config parameters to all modules
# Add v1.2 parameter handling

# Example:
preprocessor_params = {
    'smoothing_window': config.get('smoothing_window', 7),
    'smoothing_window_velocity': config.get('smoothing_window_velocity', 5),
    'smoothing_window_rom': config.get('smoothing_window_rom', 3),
    'expected_body_length_cm': config.get('expected_body_length_cm', 10.0),
    ...
}
```

**Estimated Effort**: 2-3 hours

**Phase 3 Total**: ~7-8 hours

---

### Phase 4: Validation & Documentation (Week 4)

#### 4.1 Validation Script

**File**: `validate_calibration_v1.2.py` (NEW)

**Purpose**: Compare v1.1 vs v1.2 results

**Features**:
- Run same sample with both configs
- Generate before/after comparison plots
- Compute metric improvements
- Validate against manual annotations

**Estimated Effort**: 6-8 hours

#### 4.2 Documentation Updates

**Files to Update**:
1. `docs/API_REFERENCE.md` - New parameters
2. `docs/SYSTEM_OVERVIEW.md` - v1.2 section
3. `docs/V1.2_MIGRATION_GUIDE.md` (NEW)
4. `CHANGELOG.md` - v1.2.0 release notes

**Estimated Effort**: 4-5 hours

**Phase 4 Total**: ~11-13 hours

---

## Total Implementation Estimate

| Phase | Description | Estimated Time |
|-------|-------------|----------------|
| Phase 1 | Core fixes | 10-13 hours |
| Phase 2 | Metrics & aggregation | 10-12 hours |
| Phase 3 | Visualization & config | 7-8 hours |
| Phase 4 | Validation & docs | 11-13 hours |
| **Total** | **Full v1.2.0 implementation** | **38-46 hours (~1 week)** |

---

## Current Code Status

### ✅ What Works Now (v1.1.0)

1. **Config Loading**: v1.2 config loads successfully
2. **Dry-Run**: Batch processing recognizes all parameters
3. **Existing Pipeline**: v1.1.0 code runs with new config (ignores new params)

### ⚠️ What Needs Implementation

**New Parameters (Not Yet Supported)**:
- `scaling_method: "full_body"`
- `smoothing_window_velocity: 5`
- `smoothing_window_rom: 3`
- `smoothing_adaptive: true`
- `velocity_ema_alpha: 0.35`
- `use_3d_com: true`
- `com_weights: {...}`
- `rom_use_triplet_angles: true`
- `allow_micro_steps: true`
- `micro_step_threshold_cm: 1.0`
- `aggregation_include_ci: true`
- `plot_y_margin: 0.20`
- `plot_show_micro_steps: true`
- `plot_show_threshold_lines: true`

**These parameters are defined in config but ignored by v1.1.0 code.**

---

## Testing Strategy

### Unit Tests (To Be Created)

**File**: `tests/test_calibration_v1.2.py`

```python
def test_full_body_scaling():
    """Test new full-body scaling vs legacy."""
    # Verify 20-25% increase

def test_reduced_smoothing():
    """Test reduced smoothing windows."""
    # Verify peak preservation

def test_hybrid_threshold():
    """Test hybrid MAD + percentile threshold."""
    # Verify relaxed thresholds

def test_micro_step_detection():
    """Test micro-step flagging."""
    # Verify <1cm strides included

def test_3d_com_calculation():
    """Test 3D COM from TOP+SIDE."""
    # Verify 10-20% speed increase

def test_triplet_rom_angles():
    """Test angle-based ROM."""
    # Verify 30-50% ROM increase

def test_enhanced_aggregation():
    """Test CI and corrected mean."""
    # Verify new statistical measures
```

### Integration Tests

**File**: `tests/test_pipeline_v1.2.py`

```python
def test_end_to_end_v1_2():
    """Run full pipeline with v1.2 config."""
    # Compare output metrics to expected ranges

def test_backward_compatibility():
    """Ensure v1.1 config still works."""
    # No breaking changes

def test_performance():
    """Measure v1.2 processing time."""
    # Target: <20% slower than v1.1
```

### Validation Tests (Manual)

1. **Manual Annotation Comparison** (50 strides × 6 samples)
   - Target: >85% agreement

2. **Visual Inspection**
   - Before/after plots
   - Trajectory overlays

3. **Metric Range Validation**
   - Stride length: 2-6 cm (physiological range)
   - Cadence: 20-60 steps/min (exploratory)
   - ROM: 20-60° (normal joint angles)

---

## Risk Assessment

### High Risk

**Risk**: Over-correction produces false positives
**Mitigation**:
- Implement quality scoring
- Provide conservative/sensitive presets
- Manual review flags

**Risk**: Breaking changes affect users
**Mitigation**:
- Backward compatibility flag
- Migration guide
- Keep v1.1 as legacy option

### Medium Risk

**Risk**: Performance degradation >20%
**Mitigation**:
- Profile bottlenecks
- Optimize 3D COM calculation
- Provide "fast" mode

### Low Risk

**Risk**: Manual validation fails
**Mitigation**:
- Multiple annotators
- Iterative threshold tuning
- Accept 10-15% variance

---

## Next Steps

### Immediate Actions (This Week)

1. **Create v1.2 Implementation Branch**
   ```bash
   git checkout -b feature/v1.2-metric-calibration
   ```

2. **Begin Phase 1 Implementation**
   - Start with `preprocessor.py` scaling fix
   - Implement full-body scaling method
   - Test on control_5 sample

3. **Set Up Testing Framework**
   - Create `tests/test_calibration_v1.2.py`
   - Implement unit tests for new functions

### Week 2-3 Actions

4. **Complete Core Implementation**
   - Phases 2-3 (metrics, visualization)

5. **Integration Testing**
   - End-to-end pipeline validation
   - Performance benchmarking

### Week 4 Actions

6. **Validation & Documentation**
   - Manual annotation comparison
   - Before/after report generation
   - API documentation updates

7. **Release Preparation**
   - Changelog
   - Migration guide
   - Release notes

---

## Success Criteria

### Quantitative

- ✅ Stride length: +20-40%
- ✅ Cadence: +15-35%
- ✅ ROM: +30-50%
- ✅ Angular velocity: ×2-×4
- ✅ Processing time: <20% slower
- ✅ Manual validation: >85% agreement

### Qualitative

- ✅ Metrics in physiologically realistic ranges
- ✅ Plots show dynamic variance
- ✅ User feedback: "makes sense"
- ✅ Reduced troubleshooting requests

---

## Resources

### Documentation

- [METRIC_CALIBRATION_PRD.md](METRIC_CALIBRATION_PRD.md) - Complete PRD
- [config_v1.2_calibrated.yaml](config_v1.2_calibrated.yaml) - Target config
- [docs/API_REFERENCE.md](docs/API_REFERENCE.md) - Current API (needs update)

### Code References

- `src/exmo_gait/core/preprocessor.py` - Scaling & smoothing
- `src/exmo_gait/analysis/phase_detector.py` - Thresholds
- `src/exmo_gait/analysis/step_detector.py` - Stride detection
- `src/exmo_gait/analysis/metrics_computer.py` - Metrics calculation

### Test Data

- `control_5` - Primary test sample
- 6-sample validation set (3 open-field, 2 treadmill, 1 high-speed)

---

## Conclusion

**v1.2.0 Status**: Fully specified, ready for implementation

**Key Deliverables Complete**:
- ✅ Comprehensive PRD (13,000 words)
- ✅ Production config file
- ✅ Expected improvements quantified
- ✅ Implementation roadmap

**Next Action**: Begin Phase 1 implementation (estimated 1 week for complete v1.2.0)

**Estimated Timeline**: 4 weeks total (38-46 hours)

**Approval Status**: PRD approved, awaiting implementation go-ahead

---

**Document Version**: 1.0
**Last Updated**: 2025-11-21
**Status**: ✅ Ready for Implementation
